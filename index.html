<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TrashTrade â€” ì‹¤ì‚¬ìš© ì¤€ë¹„í˜• (Region A, No Dummy Users)</title>
<link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
<style>
:root{
  --main-green:#6BA368;
  --light-green:#A1C181;
  --ivory:#F7F4EA;
  --accent-yellow:#F9CC66;
  --text-dark:#2B2B2B;
  --muted:#6f6f6f;
  --card-shadow: 0 6px 18px rgba(0,0,0,0.06);
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:'Gowun Batang', serif;
  background:var(--ivory) url('https://www.transparenttextures.com/patterns/paper-fibers.png');
  color:var(--text-dark);
  -webkit-font-smoothing:antialiased;
  line-height:1.45;
  padding-bottom:80px;
}

/* Header */
.header{
  display:flex;justify-content:space-between;align-items:center;padding:14px 22px;background:var(--light-green);
  color:#fff;border-bottom:3px solid var(--main-green);border-radius:10px;margin:12px;
}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
.header-actions{display:flex;gap:10px;align-items:center}
.btn{background:var(--accent-yellow);border:none;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
.icon-btn{background:transparent;border:none;color:#fff;cursor:pointer;font-weight:700;padding:8px}

/* Layout */
.container{max-width:1100px;margin:18px auto;padding:0 18px}
.hero{background:#fff;border-radius:14px;padding:20px;margin:16px 0;box-shadow:var(--card-shadow);text-align:center}
.hero h2{color:var(--main-green);font-size:24px;margin-bottom:8px}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:14px}
.controls input,.controls select{padding:8px 10px;border-radius:10px;border:1px solid #e6e6e6}

/* Grid */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;max-width:1100px;margin:0 auto}
.card{background:#fff;border-radius:12px;overflow:hidden;box-shadow:var(--card-shadow);display:flex;flex-direction:column;transition:transform .15s}
.card:hover{transform:translateY(-6px)}
.card img{width:100%;height:160px;object-fit:cover}
.card-content{padding:12px;display:flex;flex-direction:column;gap:8px}
.card-content h3{color:var(--main-green);font-size:16px;margin-bottom:4px}
.card-content p{font-size:14px;color:#444;min-height:44px}
.card-footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto}
.tag{background:var(--light-green);color:#fff;padding:6px 10px;border-radius:8px;font-size:13px}

/* Panel (toggleable right sidebar) */
.panel-toggle{position:fixed;right:18px;top:96px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--main-green),var(--light-green));color:#fff;border:none;cursor:pointer;z-index:60}
.panel{position:fixed;right:-420px;top:0;width:400px;height:100%;background:#fff;box-shadow:-8px 0 30px rgba(0,0,0,0.12);padding:16px;transition:right .35s;z-index:59;overflow:auto}
.panel.open{right:0}
.panel h3{margin-bottom:10px}
.small{font-size:13px;color:var(--muted)}

/* panel inner */
.section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #f0f0f0}
.profile-row{display:flex;gap:10px;align-items:center}
.avatar{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--main-green),var(--light-green));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px}
.badge{background:#FF4D4F;color:#fff;padding:4px 8px;border-radius:999px;font-weight:700;font-size:13px}
.chat-list{max-height:220px;overflow:auto}
.chat-item{padding:8px;border-radius:8px;border:1px solid #f0f0f0;margin-bottom:8px;cursor:pointer}
.chat-item:hover{background:#fafafa}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:70}
.modal{background:#fff;border-radius:12px;padding:16px;max-width:760px;width:100%;max-height:90vh;overflow:auto}
.form-row{display:flex;gap:8px;margin:8px 0;flex-wrap:wrap}
.form-row input[type="text"],.form-row textarea,.form-row select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6e6e6}
.form-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
.preview{width:120px;height:90px;border-radius:8px;background:#f3f3f3;display:flex;align-items:center;justify-content:center;color:#999}

/* dashboard */
.dashboard{background:#fff;padding:12px;border-radius:12px;box-shadow:var(--card-shadow);margin-top:12px}
.kv{display:flex;justify-content:space-between;align-items:center;padding:8px 0}

/* responsive */
@media(max-width:1000px){ .panel{width:360px} .panel.open{right:0} .panel-toggle{right:12px} }
@media(max-width:700px){
  .grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}
  .panel{width:100%;right:-100%}
  .panel.open{right:0}
  .panel-toggle{display:none}
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="brand">
    <div class="logo">TT</div>
    <div>
      <div style="font-weight:800;font-size:18px">TrashTrade ğŸŒ¿</div>
      <div class="small">ë²„ë¦¬ëŠ” ëŒ€ì‹  êµí™˜ â€” ì‹œÂ·ë„ / ì‹œÂ·êµ°Â·êµ¬ ê¸°ë°˜ (ë™ ìƒëµ)</div>
    </div>
  </div>
  <div class="header-actions">
    <button id="openRegister" class="btn">ë¬¼í’ˆ ë“±ë¡</button>
    <button id="openChallenges" class="btn">ì±Œë¦°ì§€</button>
    <button id="openProfile" class="btn">í”„ë¡œí•„</button>
    <button id="togglePanel" class="panel-toggle" title="ì‚¬ì´ë“œ íŒ¨ë„ ì—´ê¸°">â˜°</button>
  </div>
</div>

<!-- Main -->
<div class="container">
  <section class="hero">
    <h2>ë‹¤ì‹œ ì“°ëŠ” ê¸°ì¨, ì§€êµ¬ì™€ í•¨ê»˜ ğŸŒ</h2>
    <p class="small">ì§€ì—­ ë‚´ ìì›ì„ êµí™˜í•˜ì—¬ íƒ„ì†Œë¥¼ ì ˆì•½í•˜ê³ , í¬ì¸íŠ¸ë¡œ ë³´ìƒë°›ëŠ” ì»¤ë®¤ë‹ˆí‹°ì…ë‹ˆë‹¤.</p>
  </section>

  <div class="controls">
    <input id="searchInput" placeholder="ë¬¼í’ˆëª… ë˜ëŠ” ì„¤ëª… ê²€ìƒ‰">
    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
      <option>ì±…</option>
      <option>ì˜ë¥˜</option>
      <option>ì „ìê¸°ê¸°</option>
      <option>ê¸°íƒ€</option>
    </select>
    <select id="sidoSelect"></select>
    <select id="sigunSelect"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select>
    <button id="viewDashboard" class="btn">ëŒ€ì‹œë³´ë“œ</button>
  </div>

  <div id="grid" class="grid"></div>

  <div id="dashboardArea"></div>
</div>

<!-- Panel -->
<div id="panel" class="panel" aria-hidden="true">
  <div class="section">
    <h3>ë‚´ í”„ë¡œí•„ <span id="notifBadge" style="float:right"></span></h3>
    <div class="profile-row">
      <div class="avatar" id="pAvatar">?</div>
      <div>
        <div id="pName" style="font-weight:800">ë¹„ë¡œê·¸ì¸</div>
        <div id="pSchool" class="small">í•™êµ/ì§€ì—­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</div>
        <div class="small">í¬ì¸íŠ¸: <span id="pPoints">0</span> Â· ê±°ë˜: <span id="pTrades">0</span></div>
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="btnOpenLogin" class="btn" style="width:100%;margin-top:8px">ë¡œê·¸ì¸ / íšŒì›</button>
      <button id="btnViewProfile" class="btn" style="width:100%;margin-top:8px">ë‚´ í™œë™ ë³´ê¸°</button>
    </div>
  </div>

  <div class="section">
    <h4>ì•Œë¦¼</h4>
    <div id="notifList" style="max-height:160px;overflow:auto"></div>
  </div>

  <div class="section">
    <h4>ì±„íŒ…</h4>
    <div id="chatList" class="chat-list"></div>
  </div>

  <div class="section">
    <h4>í¬ì¸íŠ¸ ìƒì </h4>
    <div id="shopList"></div>
  </div>

  <div class="section">
    <h4>ë­í‚¹</h4>
    <div id="rankingList"></div>
  </div>
</div>

<!-- Modal -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal" id="modal"></div>
</div>

<script>
/* ---------------- Storage keys & helpers ---------------- */
const K = {
  USERS: 'tt_users_prod_v1',
  ITEMS: 'tt_items_prod_v1',
  REQS: 'tt_reqs_prod_v1',
  CHATS: 'tt_chats_prod_v1',
  PURCHASES: 'tt_purchases_prod_v1',
  CHALLENGES: 'tt_challenges_prod_v1'
};
function uid(pref='id'){ return pref + '_' + Math.random().toString(36).slice(2,9); }
function load(key){ return JSON.parse(localStorage.getItem(key) || '[]'); }
function save(key, data){ localStorage.setItem(key, JSON.stringify(data)); }

/* ---------------- Region data (ì‹œÂ·ë„ -> ì‹œÂ·êµ°Â·êµ¬ sample) ----------------
   NOTE: This is a representative list for major cities. You can replace/extend with
   full official lists or load via JSON file / API in production.
*/
const REGION = {
  'ì„œìš¸íŠ¹ë³„ì‹œ': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
  'ë¶€ì‚°ê´‘ì—­ì‹œ': ['ê°•ì„œêµ¬','ê¸ˆì •êµ¬','ê¸°ì¥êµ°','ë‚¨êµ¬','ë™êµ¬','ë™ë˜êµ¬','ë¶€ì‚°ì§„êµ¬','ë¶êµ¬','ì‚¬ìƒêµ¬','ì‚¬í•˜êµ¬','ì„œêµ¬','ìˆ˜ì˜êµ¬','ì—°ì œêµ¬','ì˜ë„êµ¬','ì¤‘êµ¬'],
  'ì¸ì²œê´‘ì—­ì‹œ': ['ê°•í™”êµ°','ê³„ì–‘êµ¬','ë¯¸ì¶”í™€êµ¬','ë‚¨ë™êµ¬','ë™êµ¬','ë¶€í‰êµ¬','ì„œêµ¬','ì—°ìˆ˜êµ¬','ì˜¹ì§„êµ°'],
  'ëŒ€êµ¬ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°','ë™êµ¬','ë¶êµ¬','ì„œêµ¬','ìˆ˜ì„±êµ¬','ì¤‘êµ¬'],
  'ê´‘ì£¼ê´‘ì—­ì‹œ': ['ê´‘ì‚°êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ì„œêµ¬'],
  'ëŒ€ì „ê´‘ì—­ì‹œ': ['ëŒ€ë•êµ¬','ë™êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ì¤‘êµ¬'],
  'ìš¸ì‚°ê´‘ì—­ì‹œ': ['ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°','ì¤‘êµ¬'],
  'ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ': ['ì„¸ì¢…ì‹œ'],
  'ê²½ê¸°ë„': ['ìˆ˜ì›ì‹œ','ì„±ë‚¨ì‹œ','ê³ ì–‘ì‹œ','ìš©ì¸ì‹œ','ë¶€ì²œì‹œ','í™”ì„±ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ì•ˆì‚°ì‹œ','ì•ˆì–‘ì‹œ','í‰íƒì‹œ','ì˜ì •ë¶€ì‹œ','ì‹œí¥ì‹œ','íŒŒì£¼ì‹œ','ê´‘ëª…ì‹œ','ê¹€í¬ì‹œ','ê´‘ì£¼ì‹œ','í•˜ë‚¨ì‹œ','ì´ì²œì‹œ','ì–‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','êµ¬ë¦¬ì‹œ','êµ°í¬ì‹œ','ì–‘í‰êµ°','ì—°ì²œêµ°','ì—¬ì£¼ì‹œ','ê°€í‰êµ°','í¬ì²œì‹œ'],
  // ... add more if desired
};

/* ---------------- Carbon calculation (simple model) ---------------- */
function calcCarbon(category, condition){
  const base = {'ì±…':2.0,'ì˜ë¥˜':8.0,'ì „ìê¸°ê¸°':50.0,'ê¸°íƒ€':4.0};
  const condMul = {'ìµœìƒ':1.0,'ì¢‹ìŒ':0.9,'ë³´í†µ':0.75,'ë‚¡ìŒ':0.5};
  return +(((base[category]||3.0) * (condMul[condition] || 0.75)).toFixed(2));
}

/* ---------------- Init (no dummy users) ---------------- */
function init(){
  if(!localStorage.getItem(K.USERS)) save(K.USERS, []);
  if(!localStorage.getItem(K.ITEMS)) save(K.ITEMS, []);
  if(!localStorage.getItem(K.REQS)) save(K.REQS, []);
  if(!localStorage.getItem(K.CHATS)) save(K.CHATS, []);
  if(!localStorage.getItem(K.PURCHASES)) save(K.PURCHASES, []);
  if(!localStorage.getItem(K.CHALLENGES)) save(K.CHALLENGES, [{id:'ch_week1', title:'ì´ë²ˆ ì£¼ 2ê±´ êµí™˜', target:2, reward:20}]);
}
init();

/* ---------------- App state ---------------- */
let users = load(K.USERS);
let items = load(K.ITEMS);
let requests = load(K.REQS);
let chats = load(K.CHATS);
let purchases = load(K.PURCHASES);
let challenges = load(K.CHALLENGES);
let currentUserId = localStorage.getItem('tt_current_user') || null;

/* ---------------- UI refs ---------------- */
const grid = document.getElementById('grid');
const modalBackdrop = document.getElementById('modalBackdrop');
const modal = document.getElementById('modal');
const panel = document.getElementById('panel');
const panelToggle = document.getElementById('togglePanel');
const sidoSelect = document.getElementById('sidoSelect');
const sigunSelect = document.getElementById('sigunSelect');
const notifBadgeEl = document.getElementById('notifBadge');

/* ---------------- Utility functions ---------------- */
function persistAll(){ save(K.USERS, users); save(K.ITEMS, items); save(K.REQS, requests); save(K.CHATS, chats); save(K.PURCHASES, purchases); save(K.CHALLENGES, challenges); if(currentUserId) localStorage.setItem('tt_current_user', currentUserId); else localStorage.removeItem('tt_current_user'); }
function findUserById(id){ return users.find(u=>u.id===id) || null; }
function findItemById(id){ return items.find(i=>i.id===id) || null; }

/* ---------------- Region UI population ---------------- */
function populateSido(){
  sidoSelect.innerHTML = '<option value="">ì‹œÂ·ë„ ì„ íƒ</option>';
  Object.keys(REGION).forEach(sido=>{
    const opt = document.createElement('option'); opt.value=sido; opt.textContent=sido; sidoSelect.appendChild(opt);
  });
  sidoSelect.addEventListener('change', ()=>{
    const selected = sidoSelect.value;
    sigunSelect.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
    if(selected && REGION[selected]){
      REGION[selected].forEach(sg=>{
        const o = document.createElement('option'); o.value=sg; o.textContent=sg; sigunSelect.appendChild(o);
      });
    }
    renderGrid();
  });
  sigunSelect.addEventListener('change', ()=> renderGrid());
}
populateSido();

/* ---------------- Panel toggle & render ---------------- */
panelToggle.onclick = ()=>{ panel.classList.toggle('open'); renderPanel(); }
function renderPanel(){
  users = load(K.USERS); items = load(K.ITEMS); requests = load(K.REQS); chats = load(K.CHATS); challenges = load(K.CHALLENGES);
  const me = findUserById(currentUserId);
  document.getElementById('pAvatar').textContent = me? me.name.slice(0,2):'?';
  document.getElementById('pName').textContent = me? me.name:'ë¹„ë¡œê·¸ì¸';
  document.getElementById('pSchool').textContent = me? me.school:'í•™êµ/ì§€ì—­ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”';
  document.getElementById('pPoints').textContent = me? me.points||0:0;
  document.getElementById('pTrades').textContent = me? me.trades||0:0;

  // notifications: pending reqs to me
  const notifList = document.getElementById('notifList'); notifList.innerHTML='';
  if(!me) notifList.innerHTML='<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì•Œë¦¼ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
  else {
    const mine = requests.filter(r=>r.toUserId===me.id && r.status==='pending');
    if(mine.length===0) notifList.innerHTML='<div class="small">ìƒˆ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    else mine.forEach(r=>{
      const from = findUserById(r.fromUserId);
      const it = findItemById(r.itemId);
      const div = document.createElement('div'); div.style.padding='8px'; div.style.border='1px dashed #eee'; div.style.marginBottom='8px';
      div.innerHTML = `<div style="font-weight:700">${from?from.name:'ìµëª…'}</div><div class="small">${it?it.title:'[ì‚­ì œëœ ë¬¼í’ˆ]'}ì— ëŒ€í•œ êµí™˜ ì œì•ˆ</div>
        <div style="margin-top:8px;text-align:right"><button onclick="respondRequest('${r.id}','accepted')" class="btn">ìˆ˜ë½</button> <button onclick="respondRequest('${r.id}','rejected')">ê±°ì ˆ</button></div>`;
      notifList.appendChild(div);
    });
  }

  // chats
  const chatListEl = document.getElementById('chatList'); chatListEl.innerHTML='';
  if(me){
    chats.forEach(ch=>{
      if(ch.participants.includes(me.id)){
        const otherId = ch.participants.find(p=>p!==me.id);
        const other = findUserById(otherId) || {name:'ìµëª…'};
        const el = document.createElement('div'); el.className='chat-item'; el.textContent = `${other.name} Â· ${ch.topic}`; el.onclick = ()=> openChatModal(ch.id);
        chatListEl.appendChild(el);
      }
    });
    if(chatListEl.children.length===0) chatListEl.innerHTML='<div class="small">í™œë™ ì¤‘ì¸ ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
  } else chatListEl.innerHTML='<div class="small">ë¡œê·¸ì¸í•˜ë©´ ì±„íŒ…ì„ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';

  // shop
  const shopList = document.getElementById('shopList'); shopList.innerHTML='';
  const shopCatalog = [{id:'s_seed',title:'ì”¨ì•— í‚¤íŠ¸',price:30},{id:'s_sticker',title:'ìŠ¤í‹°ì»¤íŒ©',price:20},{id:'s_bag',title:'ë¦¬ìœ ì¦ˆ ì—ì½”ë°±',price:120}];
  shopCatalog.forEach(si=>{
    const d = document.createElement('div'); d.style.display='flex'; d.style.justifyContent='space-between'; d.style.marginBottom='8px';
    d.innerHTML = `<div><strong>${si.title}</strong><div class="small">${si.price}P</div></div><div><button onclick="buyShop('${si.id}')">êµ¬ë§¤</button></div>`;
    shopList.appendChild(d);
  });

  // ranking
  const rankEl = document.getElementById('rankingList'); rankEl.innerHTML='';
  const sorted = [...users].sort((a,b)=> (b.points||0) - (a.points||0) );
  sorted.slice(0,10).forEach((u,i)=>{
    const r = document.createElement('div'); r.style.padding='6px 0'; r.innerHTML = `${i+1}. <strong>${u.name}</strong> <div class="small">${u.school||'-'}</div><div style="float:right;font-weight:700">${u.points||0}P</div>`;
    rankEl.appendChild(r);
  });

  // notif badge
  const badgeCount = me ? requests.filter(r=>r.toUserId===me.id && r.status==='pending').length : 0;
  notifBadgeEl.innerHTML = badgeCount>0 ? `<span class="badge">${badgeCount}</span>` : '';
}

/* ---------------- Grid render ---------------- */
function renderGrid(){
  users = load(K.USERS); items = load(K.ITEMS); requests = load(K.REQS); chats = load(K.CHATS);
  grid.innerHTML = '';
  const q = document.getElementById('searchInput').value.toLowerCase();
  const cat = document.getElementById('categoryFilter').value;
  const sido = document.getElementById('sidoSelect').value;
  const sigun = document.getElementById('sigunSelect').value;
  items.filter(it=> it.status==='available' ).forEach(it=>{
    if(cat && it.category !== cat) return;
    if(sido && it.sido !== sido) return;
    if(sigun && it.sigun !== sigun) return;
    if(q && !(it.title.toLowerCase().includes(q) || it.desc.toLowerCase().includes(q))) return;
    const owner = findUserById(it.ownerId) || {name:'ìµëª…'};
    const card = document.createElement('div'); card.className='card';
    const img = document.createElement('img'); img.src = it.image || placeholder(it.category);
    const content = document.createElement('div'); content.className='card-content';
    const h3 = document.createElement('h3'); h3.textContent = it.title;
    const p = document.createElement('p'); p.textContent = it.desc;
    const meta = document.createElement('div'); meta.className='small'; meta.textContent = `${it.category} Â· ${it.sido||''} ${it.sigun?('/ ' + it.sigun):''} Â· ì†Œìœ : ${owner.name}`;
    const footer = document.createElement('div'); footer.className='card-footer';
    const tag = document.createElement('div'); tag.className='tag'; tag.textContent = it.category;
    const btn = document.createElement('button'); btn.className='exchange-btn'; btn.textContent='êµí™˜ ì œì•ˆ';
    btn.onclick = ()=> openRequestModal(it.id);
    const chatBtn = document.createElement('button'); chatBtn.className='btn'; chatBtn.textContent='ì±„íŒ…';
    chatBtn.style.background='transparent'; chatBtn.style.border='1px solid #e6e6e6'; chatBtn.onclick = ()=> openOrCreateChat(it.id);
    footer.appendChild(tag); footer.appendChild(btn);
    content.appendChild(h3); content.appendChild(p); content.appendChild(meta); content.appendChild(footer);
    card.appendChild(img); card.appendChild(content);
    grid.appendChild(card);
  });
}

/* placeholder images (same as before) */
function placeholder(cat){
  const map = {'ì±…':'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=800&q=60',
               'ì˜ë¥˜':'https://images.unsplash.com/photo-1520975910870-83f4a4c3b5f1?auto=format&fit=crop&w=800&q=60',
               'ì „ìê¸°ê¸°':'https://images.unsplash.com/photo-1518779578993-ec3579fee39f?auto=format&fit=crop&w=800&q=60',
               'ê¸°íƒ€':'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=800&q=60'};
  return map[cat]||map['ê¸°íƒ€'];
}

/* ---------------- Register / Image upload (with region selection) ---------------- */
document.getElementById('openRegister').addEventListener('click', ()=> {
  openRegisterModal();
});
function recommendCategoryFromText(text){
  const t = text.toLowerCase();
  if(/book|ì°¸ê³ |êµê³¼|ìˆ˜í•™|ë¬¸í•™|ì˜ì–´|ë„ì„œ|ì±…/.test(t)) return 'ì±…';
  if(/coat|jacket|ì…”ì¸ |í‹°ì…”ì¸ |ë‹ˆíŠ¸|ì˜·|ì˜ë¥˜|ê°€ë””ê±´|ë°”ì§€|ìŠ¤ì»¤íŠ¸/.test(t)) return 'ì˜ë¥˜';
  if(/phone|í‚¤ë³´ë“œ|ë…¸íŠ¸ë¶|ì „ì|ì¶©ì „ê¸°|ë¦¬ëª¨ì»¨|ê¸°ê¸°|ì „ìê¸°ê¸°|pc|ì»´í“¨í„°/.test(t)) return 'ì „ìê¸°ê¸°';
  return 'ê¸°íƒ€';
}
function openRegisterModal(){
  if(!currentUserId){ alert('ë¬¼í’ˆ ë“±ë¡í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  let sidoOptions = `<select id="regSido">`;
  Object.keys(REGION).forEach(sido => sidoOptions += `<option value="${sido}">${sido}</option>`);
  sidoOptions += `</select>`;
  openModal(`
    <h3>ë¬¼í’ˆ ë“±ë¡</h3>
    <div class="form-row"><input id="itemTitle" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: ìˆ˜í•™ ì°¸ê³ ì„œ)"></div>
    <div class="form-row"><textarea id="itemDesc" placeholder="ìƒì„¸ ì„¤ëª… (ìƒíƒœ, ì‚¬ì´ì¦ˆ ë“±)" rows="3"></textarea></div>
    <div class="form-row">
      <select id="itemCategory"><option>ì±…</option><option>ì˜ë¥˜</option><option>ì „ìê¸°ê¸°</option><option>ê¸°íƒ€</option></select>
      <select id="itemCondition"><option>ìµœìƒ</option><option>ì¢‹ìŒ</option><option>ë³´í†µ</option><option>ë‚¡ìŒ</option></select>
    </div>
    <div class="form-row">
      <input type="file" id="itemImage" accept="image/*">
      <div class="preview" id="imgPreview">ë¯¸ë¦¬ë³´ê¸°</div>
    </div>
    <div class="form-row">
      ${sidoOptions}
      <select id="regSigun"><option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option></select>
    </div>
    <div class="form-row"><input id="itemWish" placeholder="êµí™˜ í¬ë§(ì˜ˆ: ì±…, ì˜ë¥˜ ë“±)"></div>
    <div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button onclick="doRegister()">ë“±ë¡</button></div>
  `);
  const titleEl = document.getElementById('itemTitle');
  const catEl = document.getElementById('itemCategory');
  const sidoEl = document.getElementById('regSido');
  const sigunEl = document.getElementById('regSigun');
  const imgInput = document.getElementById('itemImage');
  const preview = document.getElementById('imgPreview');

  titleEl.addEventListener('input', ()=>{ const rec = recommendCategoryFromText(titleEl.value); if(rec) catEl.value = rec; });
  sidoEl.addEventListener('change', ()=>{
    sigunEl.innerHTML = '<option value="">ì‹œÂ·êµ°Â·êµ¬ ì„ íƒ</option>';
    if(REGION[sidoEl.value]) REGION[sidoEl.value].forEach(sg=>{ const o=document.createElement('option'); o.value=sg; o.textContent=sg; sigunEl.appendChild(o); });
  });
  imgInput.onchange = (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ preview.style.backgroundImage = `url(${reader.result})`; preview.style.backgroundSize='cover'; preview.textContent=''; preview.dataset.src = reader.result; }
    reader.readAsDataURL(f);
  };
}
function doRegister(){
  const title = document.getElementById('itemTitle').value.trim();
  const desc = document.getElementById('itemDesc').value.trim();
  const category = document.getElementById('itemCategory').value;
  const condition = document.getElementById('itemCondition').value;
  const sido = document.getElementById('regSido').value;
  const sigun = document.getElementById('regSigun').value;
  const preview = document.getElementById('imgPreview');
  if(!title || !desc){ alert('ë¬¼í’ˆëª…ê³¼ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
  const image = preview.dataset.src || placeholder(category);
  const it = { id: uid('it'), title, desc, category, condition, image, ownerId: currentUserId, sido, sigun, status:'available', carbon: calcCarbon(category, condition), created: Date.now() };
  items = load(K.ITEMS); items.unshift(it); save(K.ITEMS, items); persistAll();
  closeModal(); renderGrid(); renderPanel(); alert('ë¬¼í’ˆì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

/* ---------------- Request / Accept / Trade flow ---------------- */
function openRequestModal(itemId){
  if(!currentUserId){ alert('êµí™˜ ì œì•ˆí•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItemById(itemId);
  if(!it) return alert('ë¬¼í’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  if(it.ownerId === currentUserId) return alert('ë³¸ì¸ ë¬¼í’ˆì…ë‹ˆë‹¤.');
  openModal(`<h3>êµí™˜ ì œì•ˆ â€” ${it.title}</h3><div class="small">ì†Œìœ ì: ${findUserById(it.ownerId).name}</div><div class="form-row"><textarea id="reqMsg" placeholder="êµí™˜ ì œì•ˆ ë©”ì‹œì§€" rows="3"></textarea></div><div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button onclick="sendRequest('${itemId}')">ì œì•ˆ ë³´ë‚´ê¸°</button></div>`);
}
function sendRequest(itemId){
  const message = document.getElementById('reqMsg').value.trim();
  const it = findItemById(itemId);
  if(!it) return alert('ë¬¼í’ˆ ì—†ìŒ');
  const req = { id: uid('req'), itemId, fromUserId: currentUserId, toUserId: it.ownerId, message, status:'pending', created: Date.now() };
  requests = load(K.REQS); requests.push(req); save(K.REQS, requests);
  // add chat thread or create if not exists
  let thread = chats.find(c=> c.itemId===itemId && c.participants.includes(currentUserId) && c.participants.includes(it.ownerId));
  if(!thread){
    thread = { id: uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] };
    chats = load(K.CHATS); chats.push(thread); save(K.CHATS, chats);
  }
  thread.messages.push({ id: uid('m'), from: currentUserId, text: message || 'êµí™˜ ì œì•ˆë“œë¦½ë‹ˆë‹¤.', time: Date.now() });
  save(K.CHATS, chats); persistAll();
  closeModal(); renderPanel(); alert('êµí™˜ ì œì•ˆì´ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* respond to request (accept/reject) */
function respondRequest(reqId, action){
  requests = load(K.REQS);
  const r = requests.find(x=>x.id===reqId); if(!r) return;
  if(action==='rejected'){ r.status='rejected'; save(K.REQS, requests); persistAll(); renderPanel(); alert('ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
  if(action==='accepted'){
    r.status='accepted';
    // perform trade: mark item traded, award points, update eco
    items = load(K.ITEMS);
    const it = items.find(i=>i.id===r.itemId);
    if(!it){ alert('ì•„ì´í…œ ì—†ìŒ'); return; }
    it.status = 'traded';
    save(K.ITEMS, items);
    users = load(K.USERS);
    const proposer = users.find(u=>u.id===r.fromUserId);
    const owner = users.find(u=>u.id===r.toUserId);
    const carbonBonus = Math.round(it.carbon || 0);
    if(proposer){ proposer.points = (proposer.points||0) + 10 + carbonBonus; proposer.trades = (proposer.trades||0)+1; proposer.eco = (proposer.eco||0) + (it.carbon||0); }
    if(owner){ owner.points = (owner.points||0) + 5 + Math.floor(carbonBonus/2); owner.trades = (owner.trades||0)+1; owner.eco = (owner.eco||0) + (it.carbon||0); }
    save(K.USERS, users); save(K.REQS, requests); persistAll();
    // notify via chat
    let thread = chats.find(c=>c.itemId===it.id && c.participants.includes(r.fromUserId) && c.participants.includes(r.toUserId));
    if(!thread){
      thread = { id: uid('ch'), itemId: it.id, topic: it.title, participants:[r.fromUserId, r.toUserId], messages: [] };
      chats.push(thread); save(K.CHATS, chats);
    }
    thread.messages.push({ id: uid('m'), from: r.toUserId, text:'ê±°ë˜ë¥¼ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤. ê°ì‚¬í•©ë‹ˆë‹¤!', time: Date.now() });
    save(K.CHATS, chats); persistAll();
    renderGrid(); renderPanel(); alert('ê±°ë˜ ì™„ë£Œ! í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
  }
}

/* ---------------- Chat UI ---------------- */
function openOrCreateChat(itemId){
  if(!currentUserId){ alert('ì±„íŒ…í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const it = findItemById(itemId);
  if(!it) return;
  let thread = chats.find(c=> c.itemId===itemId && c.participants.includes(currentUserId));
  if(!thread){
    thread = { id: uid('ch'), itemId, topic: it.title, participants: [currentUserId, it.ownerId], messages: [] };
    chats.push(thread); save(K.CHATS, chats); persistAll();
  }
  openChatModal(thread.id);
}
function openChatModal(threadId){
  const thread = chats.find(c=>c.id===threadId);
  if(!thread){ alert('ì±„íŒ… ìŠ¤ë ˆë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
  let html = `<h3>ì±„íŒ… â€” ${thread.topic}</h3><div id="chatBox" style="max-height:360px;overflow:auto;border:1px solid #f0f0f0;padding:8px;margin-bottom:8px">`;
  thread.messages.forEach(m=>{
    const from = findUserById(m.from);
    const side = (m.from===currentUserId)?'right':'left';
    html += `<div style="margin:6px 0;text-align:${side}"><div style="display:inline-block;background:${m.from===currentUserId? 'linear-gradient(135deg,var(--main-green),var(--light-green))':'#f4f4f4'};color:${m.from===currentUserId? '#fff':'#333'};padding:8px;border-radius:8px;max-width:80%;">${m.text}</div><div class="small" style="margin-top:4px">${from?from.name:'ìµëª…'}</div></div>`;
  });
  html += `</div><div class="form-row"><input id="chatInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button><button onclick="sendChat('${thread.id}')">ì „ì†¡</button></div>`;
  openModal(html);
}
function sendChat(threadId){
  const txt = document.getElementById('chatInput').value.trim(); if(!txt) return;
  const th = chats.find(c=>c.id===threadId);
  th.messages.push({ id: uid('m'), from: currentUserId, text: txt, time: Date.now() });
  save(K.CHATS, chats); persistAll(); openChatModal(threadId);
}

/* ---------------- Shop purchase ---------------- */
function buyShop(shopId){
  if(!currentUserId){ alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•˜ì„¸ìš”.'); openLoginModal(); return; }
  const catalog = { 's_seed':{title:'ì”¨ì•—í‚¤íŠ¸',price:30}, 's_sticker':{title:'ìŠ¤í‹°ì»¤íŒ©',price:20}, 's_bag':{title:'ë¦¬ìœ ì¦ˆ ì—ì½”ë°±',price:120} };
  const item = catalog[shopId];
  const me = findUserById(currentUserId);
  if(!me) return;
  if(me.points < item.price) return alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
  if(!confirm(`${item.title}ì„(ë¥¼) ${item.price}Pë¡œ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì‹¤ì œ ë°°ì†¡ ì—°ê²° ì „ì—ëŠ” ëª¨ì˜ ì²˜ë¦¬ì…ë‹ˆë‹¤)`)) return;
  me.points -= item.price;
  purchases.push({ id: uid('p'), userId: me.id, title: item.title, date: Date.now() });
  save(K.PURCHASES, purchases); save(K.USERS, users); persistAll(); alert('êµ¬ë§¤ ì™„ë£Œ(ëª¨ì˜ ì²˜ë¦¬). ì‹¤ì œ ë°°ì†¡ ì—°ë™ì„ ì›í•˜ë©´ ë°°ì†¡ APIë¥¼ ì—°ê²°í•˜ì„¸ìš”.');
  renderPanel();
}

/* ---------------- Dashboard & metrics ---------------- */
function renderDashboard(){
  const traded = items.filter(i=>i.status==='traded');
  const totalCarbon = traded.reduce((s,it)=>s + (it.carbon||0), 0);
  const tradedCount = traded.length;
  const html = `<div class="dashboard"><h3>íƒ„ì†Œì ˆê° ëŒ€ì‹œë³´ë“œ</h3><div class="kv"><div>ëˆ„ì  ì ˆê°ëŸ‰</div><div style="font-weight:800">${totalCarbon.toFixed(2)} kg COâ‚‚</div></div><div class="kv"><div>ê±°ë˜ ê±´ìˆ˜</div><div style="font-weight:800">${tradedCount} ê±´</div></div><div style="margin-top:8px"><strong>ìµœê·¼ ê±°ë˜</strong><div>${traded.slice(-5).map(t=>`${t.title} (${t.sido||''} ${t.sigun||''})`).join('<br>') || '<div class="small">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}</div></div></div>`;
  document.getElementById('dashboardArea').innerHTML = html; window.scrollTo({top:document.getElementById('dashboardArea').offsetTop, behavior:'smooth'});
}

/* ---------------- Challenges ---------------- */
document.getElementById('openChallenges').addEventListener('click', ()=> openChallengesModal());
function openChallengesModal(){
  let html = `<h3>ì±Œë¦°ì§€</h3><div style="max-height:60vh;overflow:auto">`;
  challenges.forEach(c=> html += `<div style="padding:8px;border-bottom:1px solid #f4f4f4"><strong>${c.title}</strong><div class="small">ë³´ìƒ ${c.reward}P Â· ëª©í‘œ ${c.target}ê±´</div><div style="margin-top:8px"><button onclick="claimChallenge('${c.id}')">ë³´ìƒ ë°›ê¸°</button></div></div>`);
  html += `</div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button></div>`;
  openModal(html);
}
function claimChallenge(id){
  if(!currentUserId){ alert('ë¡œê·¸ì¸ í•„ìš”'); openLoginModal(); return; }
  const ch = challenges.find(c=>c.id===id); const me = findUserById(currentUserId);
  if((me.trades||0) >= ch.target){
    me.points = (me.points||0) + (ch.reward||0); save(K.USERS, users); persistAll(); renderPanel(); alert('ë³´ìƒ ì§€ê¸‰ ì™„ë£Œ!');
  } else alert('ì•„ì§ ëª©í‘œë¥¼ ë‹¬ì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
}

/* ---------------- Login / Profile ---------------- */
document.getElementById('btnOpenLogin').addEventListener('click', ()=> openLoginModal());
document.getElementById('openProfile').addEventListener('click', ()=> { if(!currentUserId) openLoginModal(); else openProfileModal(); });
document.getElementById('btnViewProfile').addEventListener('click', ()=> openProfileModal());

function openLoginModal(){
  openModal(`<h3>ë¡œê·¸ì¸ / íšŒì› ë“±ë¡</h3><div class="form-row"><input id="loginName" placeholder="ì´ë¦„"></div><div class="form-row"><input id="loginSchool" placeholder="í•™êµ/ì§€ì—­"></div><div class="form-actions"><button onclick="closeModal()">ì·¨ì†Œ</button><button onclick="doLogin()">ì €ì¥</button></div>`);
}
function doLogin(){
  const name = document.getElementById('loginName').value.trim();
  const school = document.getElementById('loginSchool').value.trim();
  if(!name||!school) return alert('ì´ë¦„ê³¼ í•™êµ/ì§€ì—­ì„ ì…ë ¥í•˜ì„¸ìš”.');
  users = load(K.USERS);
  let me = users.find(u=>u.name===name && u.school===school);
  if(!me){ me = { id: uid('u'), name, school, points:0, trades:0, eco:0 }; users.push(me); save(K.USERS, users); }
  currentUserId = me.id; localStorage.setItem('tt_current_user', currentUserId); persistAll();
  closeModal(); renderPanel(); renderGrid(); alert(`${me.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!`);
}
function openProfileModal(){
  if(!currentUserId){ openLoginModal(); return; }
  const me = findUserById(currentUserId);
  let html = `<h3>ë‚´ í™œë™ â€” ${me.name}</h3><div style="max-height:60vh;overflow:auto"><div class="small">í¬ì¸íŠ¸: ${me.points}P Â· ê±°ë˜: ${me.trades||0} Â· ëˆ„ì  ì ˆê°: ${(me.eco||0).toFixed(2)}kg COâ‚‚</div><hr>`;
  html += `<h4>ë‚´ ë¬¼í’ˆ</h4>`;
  const myItems = items.filter(i=> i.ownerId===me.id );
  if(myItems.length===0) html += '<div class="small">ë“±ë¡í•œ ë¬¼í’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>'; else myItems.forEach(it=> html += `<div style="padding:8px;border-bottom:1px solid #f4f4f4">${it.title} - ${it.status}</div>`);
  html += `<hr><h4>êµ¬ë§¤ ë‚´ì—­</h4>`;
  const myPurch = purchases.filter(p=> p.userId===me.id );
  if(myPurch.length===0) html += '<div class="small">êµ¬ë§¤ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; else myPurch.forEach(p=> html += `<div style="padding:6px">${p.title} - ${new Date(p.date).toLocaleString()}</div>`);
  html += `</div><div class="form-actions"><button onclick="closeModal()">ë‹«ê¸°</button></div>`;
  openModal(html);
}

/* ---------------- send/receive modal helpers ---------------- */
function openModal(html){
  modal.innerHTML = html; modalBackdrop.style.display = 'flex';
}
function closeModal(){ modalBackdrop.style.display = 'none'; }

/* ---------------- Respond of requests exposed globally ---------------- */
window.respondRequest = respondRequest;

/* ---------------- Open chat helper exposed ---------------- */
window.openOrCreateChat = openOrCreateChat;

/* ---------------- Buy / sell / shipping API hooks (EMPTY stubs for production) ----------------
   These functions are placeholders where you plug in real payment & shipping APIs.
   - processPayment(order): integrate Stripe/Toss/PayPal server-side call
   - createShippingRequest(order): integrate courier API (CJ, í•œì§„ ë“±.) to generate tracking
*/
async function processPayment(order){
  // ORDER example: {orderId, userId, amount, currency, items:[]}
  // In production: send POST to your server which calls payment provider securely.
  // This stub just simulates success after a delay.
  console.log('processPayment (stub)', order);
  return new Promise(resolve=> setTimeout(()=> resolve({success:true, providerId:'MOCK_PAY_12345'}), 800));
}
async function createShippingRequest(order){
  // ORDER example: {orderId, toAddress:{sido,sigun,address}, items:[], courier:'CJ'}
  // In production: call courier API -> get tracking number & status
  console.log('createShippingRequest (stub)', order);
  return new Promise(resolve=> setTimeout(()=> resolve({success:true, tracking:'MOCK_TRACK_98765'}), 800));
}

/* ---------------- Save on unload ---------------- */
window.addEventListener('beforeunload', ()=> persistAll());

/* ---------------- Initial render ---------------- */
renderGrid(); renderPanel(); renderDashboard();

/* ---------------- Search/filter events ---------------- */
document.getElementById('searchInput').addEventListener('input', ()=> renderGrid());
document.getElementById('categoryFilter').addEventListener('change', ()=> renderGrid());
document.getElementById('sidoSelect').addEventListener('change', ()=> renderGrid());
document.getElementById('sigunSelect').addEventListener('change', ()=> renderGrid());

/* bind dashboard button */
document.getElementById('viewDashboard').addEventListener('click', ()=> renderDashboard());

/* expose some functions to console & UI */
window.openRegisterModal = openRegisterModal;
window.openChatModal = openChatModal;

</script>
</body>
</html>
